<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #0077b6, #00b4d8);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .dashboard-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .map-container {
            flex: 2;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 500px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .bookings-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 500px;
            overflow-y: auto;
        }
        
        .booking-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .booking-card.active {
            border-color: #0077b6;
            background: #e3f2fd;
        }
        
        .booking-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .booking-id {
            font-weight: bold;
            color: #0077b6;
        }
        
        .booking-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending { background: #ffecb3; color: #ff9800; }
        .status-confirmed { background: #bbdefb; color: #2196f3; }
        .status-completed { background: #c8e6c9; color: #4caf50; }
        
        .booking-details {
            margin-bottom: 15px;
        }
        
        .detail-item {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        button {
            background: #0077b6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #023e8a;
        }
        
        .update-location-btn {
            background: #4caf50;
        }
        
        .update-location-btn:hover {
            background: #388e3c;
        }
        
        .complete-booking-btn {
            background: #ff9800;
        }
        
        .complete-booking-btn:hover {
            background: #f57c00;
        }
        
        .action-buttons {
            margin-top: 15px;
        }
        
        .driver-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .driver-name {
            font-size: 18px;
            font-weight: bold;
        }
        
        .refresh-btn {
            background: #9c27b0;
        }
        
        .refresh-btn:hover {
            background: #7b1fa2;
        }
        
        .location-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Driver Dashboard</h1>
            <p>Manage your bookings and update your location</p>
        </header>
        
        <div class="driver-info">
            <div class="driver-name">Driver: <span id="driverName">Loading...</span></div>
            <button class="refresh-btn" onclick="loadActiveBookings()">Refresh Bookings</button>
        </div>
        
        <div class="location-info">
            <p>Last Location Update: <span id="lastLocationUpdate">Never</span></p>
            <button class="update-location-btn" onclick="updateCurrentLocation()">Update My Location</button>
        </div>
        
        <div class="dashboard-container">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="bookings-panel">
                <h2>Active Bookings</h2>
                <div id="bookingsList">
                    <p>Loading bookings...</p>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="location.href='home.html'">Back to Home</button>
            <button class="complete-booking-btn" onclick="completeCurrentBooking()">Complete Current Booking</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let driverMarker;
        let ambulanceMarker;
        let currentDriver = null;
        let currentBooking = null;
        let activeBookings = [];
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadDriverInfo();
            loadActiveBookings();
            
            // Update location every 30 seconds
            setInterval(updateCurrentLocation, 30000);
        });
        
        // Initialize the map
        function initMap() {
            // Create map centered on a default location
            map = L.map('map').setView([13.0827, 80.2707], 13); // Chennai coordinates as default
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add driver marker
            driverMarker = L.marker([13.0827, 80.2707], {
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/60/60984.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map)
                .bindPopup('Your Location');
        }
        
        // Load driver information
        function loadDriverInfo() {
            // In a real application, you would fetch this from the server
            // For demo, we'll use localStorage or prompt for driver ID
            const driverId = localStorage.getItem('driverId') || prompt('Enter your Driver ID:');
            
            if (driverId) {
                localStorage.setItem('driverId', driverId);
                
                // Fetch driver details
                fetch(`/api/drivers`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Find the driver with this ID
                            const driver = data.drivers.find(d => d._id === driverId);
                            if (driver) {
                                currentDriver = driver;
                                document.getElementById('driverName').textContent = driver.name;
                            } else {
                                document.getElementById('driverName').textContent = 'Driver ' + driverId;
                            }
                        } else {
                            document.getElementById('driverName').textContent = 'Driver ' + driverId;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading driver info:', error);
                        document.getElementById('driverName').textContent = 'Driver ' + driverId;
                    });
            }
        }
        
        // Load active bookings
        function loadActiveBookings() {
            fetch('/api/active-bookings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        activeBookings = data.bookings.filter(booking => 
                            booking.driverId && booking.driverId._id === localStorage.getItem('driverId')
                        );
                        
                        displayBookings(activeBookings);
                    } else {
                        document.getElementById('bookingsList').innerHTML = 
                            '<p>Failed to load bookings: ' + data.message + '</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading bookings:', error);
                    document.getElementById('bookingsList').innerHTML = 
                        '<p>Failed to load bookings. Please try again.</p>';
                });
        }
        
        // Display bookings in the panel
        function displayBookings(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                bookingsList.innerHTML = '<p>No active bookings assigned to you.</p>';
                return;
            }
            
            let html = '';
            bookings.forEach(booking => {
                const isActive = currentBooking && currentBooking._id === booking._id;
                
                html += `
                    <div class="booking-card ${isActive ? 'active' : ''}">
                        <div class="booking-header">
                            <div class="booking-id">Booking #${booking._id.substring(0, 8)}</div>
                            <div class="booking-status status-${booking.status}">${booking.status}</div>
                        </div>
                        <div class="booking-details">
                            <div class="detail-item">
                                <span class="detail-label">Patient:</span> ${booking.patientName}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Address:</span> ${booking.pickupAddress}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Time:</span> ${new Date(booking.bookingDateTime).toLocaleString()}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Type:</span> ${booking.ambulanceType}
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button onclick="selectBooking('${booking._id}')">Select for Tracking</button>
                        </div>
                    </div>
                `;
            });
            
            bookingsList.innerHTML = html;
        }
        
        // Select a booking for tracking
        function selectBooking(bookingId) {
            currentBooking = activeBookings.find(b => b._id === bookingId);
            displayBookings(activeBookings); // Refresh to show active selection
            
            if (currentBooking) {
                // Center map on pickup location (would need geocoding in real app)
                alert('Booking selected for tracking. In a real app, this would show the route to the patient.');
            }
        }
        
        // Update current location
        function updateCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update driver marker on map
                    driverMarker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 15);
                    
                    // Update last location time
                    document.getElementById('lastLocationUpdate').textContent = 
                        new Date().toLocaleTimeString();
                    
                    // Send location to server
                    const driverId = localStorage.getItem('driverId');
                    if (driverId && currentBooking) {
                        fetch('/api/update-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                driverId: driverId,
                                latitude: lat,
                                longitude: lng,
                                bookingId: currentBooking._id
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (!data.success) {
                                console.error('Failed to update location:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating location:', error);
                        });
                    }
                },
                function(error) {
                    console.error('Error getting location:', error);
                    alert('Unable to get your location. Please ensure location services are enabled.');
                }
            );
        }
        
        // Complete current booking
        function completeCurrentBooking() {
            if (!currentBooking) {
                alert('Please select a booking first.');
                return;
            }
            
            if (confirm('Are you sure you want to mark this booking as completed?')) {
                fetch(`/api/booking/${currentBooking._id}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Booking marked as completed.');
                        currentBooking = null;
                        loadActiveBookings(); // Refresh bookings
                    } else {
                        alert('Failed to complete booking: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error completing booking:', error);
                    alert('Failed to complete booking.');
                });
            }
        }
    </script>
</body>
</html>