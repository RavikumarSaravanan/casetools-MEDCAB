<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambulance Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #0077b6, #00b4d8);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .tracking-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .map-container {
            flex: 3;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 500px;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .info-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .info-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .info-label {
            font-weight: bold;
            color: #0077b6;
            margin-bottom: 5px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-pending { background-color: #ff9800; }
        .status-confirmed { background-color: #2196f3; }
        .status-completed { background-color: #4caf50; }
        
        .controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        button {
            background: #0077b6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #023e8a;
        }
        
        .booking-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .booking-id {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .refresh-btn {
            background: #4caf50;
        }
        
        .refresh-btn:hover {
            background: #388e3c;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ambulance Tracking System</h1>
            <p>Real-time tracking of your ambulance</p>
        </header>
        
        <div class="booking-info">
            <div class="booking-id">Booking ID: <span id="bookingId">Loading...</span></div>
            <button class="refresh-btn" onclick="refreshTracking()">Refresh Location</button>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="tracking-container">
            <div class="map-container">
                <div id="map"></div>
            </div>
            
            <div class="info-panel">
                <h2>Ambulance Details</h2>
                <div class="info-item">
                    <div class="info-label">Driver Name</div>
                    <div id="driverName">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Vehicle Number</div>
                    <div id="vehicleNumber">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Driver Contact</div>
                    <div id="driverContact">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Booking Status</div>
                    <div id="bookingStatus">
                        <span class="status-indicator status-pending"></span>
                        <span id="statusText">Loading...</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Last Updated</div>
                    <div id="lastUpdated">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Estimated Arrival</div>
                    <div id="eta">Calculating...</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="location.href='home.html'">Back to Home</button>
            <button onclick="cancelBooking()">Cancel Booking</button>
            <button onclick="contactDriver()">Contact Driver</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Global variables
        let map;
        let ambulanceMarker;
        let userMarker;
        let routePolyline;
        let bookingId = localStorage.getItem('currentBookingId') || getBookingIdFromUrl();
        
        // Initialize the map when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadBookingInfo();
            startTracking();
        });
        
        // Get booking ID from URL parameters
        function getBookingIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('bookingId');
        }
        
        // Initialize the map
        function initMap() {
            // Create map centered on a default location
            map = L.map('map').setView([13.0827, 80.2707], 13); // Chennai coordinates as default
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add user location marker (will be updated with actual location)
            userMarker = L.marker([13.0827, 80.2707]).addTo(map)
                .bindPopup('Your Location')
                .openPopup();
            
            // Add ambulance marker (will be updated with actual location)
            ambulanceMarker = L.marker([13.0827, 80.2707], {
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/60/60984.png',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map)
                .bindPopup('Ambulance Location');
        }
        
        // Load booking information
        function loadBookingInfo() {
            if (!bookingId) {
                showError('No booking ID found. Please go back and create a booking.');
                return;
            }
            
            document.getElementById('bookingId').textContent = bookingId;
            
            // Fetch booking details
            fetch(`/api/booking/${bookingId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const booking = data.booking;
                        document.getElementById('driverName').textContent = 
                            booking.driverId ? booking.driverId.name : 'Not assigned yet';
                        document.getElementById('vehicleNumber').textContent = 
                            booking.driverId ? booking.driverId.vehicleNumber : '-';
                        document.getElementById('driverContact').textContent = 
                            booking.driverId ? booking.driverId.contact : '-';
                        
                        // Update status
                        updateStatus(booking.status);
                    } else {
                        showError('Failed to load booking information: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading booking info:', error);
                    showError('Failed to load booking information.');
                });
        }
        
        // Update status display
        function updateStatus(status) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.querySelector('.status-indicator');
            
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            // Update status indicator color
            statusIndicator.className = 'status-indicator';
            if (status === 'pending') {
                statusIndicator.classList.add('status-pending');
            } else if (status === 'confirmed') {
                statusIndicator.classList.add('status-confirmed');
            } else if (status === 'completed') {
                statusIndicator.classList.add('status-completed');
            }
        }
        
        // Start tracking the ambulance
        function startTracking() {
            if (!bookingId) return;
            
            // Update location every 5 seconds
            setInterval(updateAmbulanceLocation, 5000);
            updateAmbulanceLocation(); // Initial update
        }
        
        // Update ambulance location on the map
        function updateAmbulanceLocation() {
            if (!bookingId) return;
            
            // For demo purposes, we'll simulate movement
            // In a real application, this would fetch actual GPS data
            fetch(`/api/booking/${bookingId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.booking.driverId) {
                        const driverId = data.booking.driverId._id;
                        
                        // Fetch driver's current location
                        return fetch(`/api/driver-location/${driverId}`);
                    }
                    return Promise.resolve({json: () => Promise.resolve({success: false})});
                })
                .then(response => response.json())
                .then(locationData => {
                    if (locationData.success && locationData.location) {
                        const location = locationData.location;
                        const lat = location.latitude;
                        const lng = location.longitude;
                        
                        // Update ambulance marker position
                        ambulanceMarker.setLatLng([lat, lng]);
                        
                        // Update map view to show both user and ambulance
                        const userLatLng = userMarker.getLatLng();
                        const bounds = L.latLngBounds([[lat, lng], [userLatLng.lat, userLatLng.lng]]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                        
                        // Update last updated time
                        document.getElementById('lastUpdated').textContent = 
                            new Date(location.timestamp).toLocaleTimeString();
                        
                        // Draw route line if we have multiple points
                        // This would be enhanced in a real implementation
                    } else {
                        // Simulate movement for demo
                        simulateAmbulanceMovement();
                    }
                })
                .catch(error => {
                    console.error('Error updating location:', error);
                    // Simulate movement for demo
                    simulateAmbulanceMovement();
                });
        }
        
        // Simulate ambulance movement for demo purposes
        function simulateAmbulanceMovement() {
            // This is just for demonstration
            // In a real app, you would get actual GPS coordinates
            const center = map.getCenter();
            const offset = (Math.random() - 0.5) * 0.01;
            
            const newLat = center.lat + offset;
            const newLng = center.lng + offset;
            
            ambulanceMarker.setLatLng([newLat, newLng]);
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }
        
        // Refresh tracking manually
        function refreshTracking() {
            updateAmbulanceLocation();
            loadBookingInfo();
        }
        
        // Cancel booking
        function cancelBooking() {
            if (confirm('Are you sure you want to cancel this booking?')) {
                fetch(`/api/booking/${bookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Booking cancelled successfully.');
                        updateStatus('cancelled');
                    } else {
                        alert('Failed to cancel booking: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error cancelling booking:', error);
                    alert('Failed to cancel booking.');
                });
            }
        }
        
        // Contact driver
        function contactDriver() {
            alert('Driver contact functionality would be implemented here.\nIn a real app, this would open a call or messaging interface.');
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>